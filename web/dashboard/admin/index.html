<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Blog Home</title>

    <!-- Font-awesome CSS File -->
    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css"/>
    <!-- Twitter Bootstrap 3 CSS File -->
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css"/>

    <!-- jQuery EasyUI CSS Files -->
    <link rel="stylesheet" href="../vendor/jquery-easyui/themes/default/easyui.css"/>

    <!-- jQuery JS File -->
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <!-- jQuery EasyUI JS File -->
    <script src="../vendor/jquery-easyui/jquery.easyui.min.js"></script>

    <script src="../vendor/bower/layer/layer.js"></script>

    <script src="../lib.js"></script>
</head>
<body>

<table id="datagrid" class="easyui-datagrid" style="width:100%" toolbar="#toolbar">
</table>

<div id="toolbar">
    <a class="btn btn-link" id="create"><span class="glyphicon glyphicon-plus"></span></a>
    <a class="btn btn-link" id="update"><span class="glyphicon glyphicon-edit"></span></a>
    <a class="btn btn-link" id="remove"><span class="glyphicon glyphicon-remove"></span></a>
</div>

<div id="form_dlg" style="padding: 50px;display:none">
    <form class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">Title</label>

            <div class="col-sm-6">
                <input name="title" type="text" class="form-control" placeholder="Title">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">Content</label>

            <div class="col-sm-6">
                <input name="content" type="text" class="form-control" placeholder="Content">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-default">Submit</button>
            </div>
        </div>
    </form>
</div>

<script>
    Identity.loginRequired();

    var dg = $('#datagrid');
    dg.datagrid({
        url: "/administrators",
        method: "get",
        fitColumns: true,
        autoRowHeight: true,
        striped: true,
        pagination: true,
        singleSelect: true,
        pageSize: 20,
        pageList: [20],
        columns: [[
            {field: 'id', title: 'ID', width: 5},
            {field: 'username', title: 'Username', width: 25},
            {field: 'role', title: 'Role', width: 70},
            {
                field: 'created_at', title: 'Created At', width: 70,
                formatter: function (value, row, index) {
                    var d = new Date(value * 1000);
                    var date = (d.getFullYear()) + "-" +
                            (d.getMonth() + 1) + "-" +
                            (d.getDate()) + " " +
                            (d.getHours()) + ":" +
                            (d.getMinutes()) + ":" +
                            (d.getSeconds());
                    return date;
                }
            }
        ]],
        loader: function (param, success, error) {
            var options = $(this).datagrid('options');
            var xhr = API.call({url: options.url + '?page=' + param.page, method: 'get'})
                    .success(function (data, textStatus, xhr) {
                        var total = xhr.getResponseHeader('X-Pagination-Total-Count');
                        success({
                            total: total,
                            rows: data
                        });
                    })
                    .error(error);
        }
    });

    var save_url;
    var layer_dlg;
    var form = $("#form_dlg form");
    $('#create').click(function () {
        form.form('clear');
        layer_dlg = layer.open({
            title: 'Create',
            type: 1,
            skin: 'layui-layer-rim',    // With border
            area: '600px',              // width
            shadeClose: true,
            content: $("#form_dlg")
        });
        save_url = {url: '/posts', method: 'post'};
    });

    $('#update').click(function () {
        form.form('clear');
        var row = dg.datagrid('getSelected');
        Debug.log(row);
        if (row) {
            form.form('load', row);
            layer_dlg = layer.open({
                title: 'Update',
                type: 1,
                skin: 'layui-layer-rim',
                area: '600px',
                shadeClose: true,
                content: $("#form_dlg")
            });
            save_url = {url: '/posts/' + row.id, method: 'patch'};
        }
    });

    $('#remove').click(function () {
        var row = dg.datagrid('getSelected');
        if (row) {
            layer.confirm('Are you sure to delete this?', function () {
                API.call({url: '/posts/' + row.id, method: 'DELETE'})
                        .success(function (data, status) {
                            layer.msg('Successfully');
                            dg.datagrid('reload');
                        })
                        .error(function (res) {
                            layer.close(layer_dlg);
                            layer.msg(res.statusText, {icon: 5, shift: 6});
                        });
            });
        }
    });

    form.submit(function () {
        var data = $(this).serialize();
        console.log(data);
        API.call({url: save_url.url, data: data, method: save_url.method})
                .success(function (data, status) {
                    layer.msg('Successfully');
                    layer.close(layer_dlg);
                    dg.datagrid('reload');
                })
                .error(function (res, text, e) {
                    var data = res.responseJSON;
                    layer.close(layer_dlg);
                    layer.msg(data.message,{icon: 5, shift: 6});
                });
        return false;
    });
</script>
</body>
</html>